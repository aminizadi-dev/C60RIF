@model PassengerModel

<div asp-validation-summary="All"></div>
<input asp-for="Id" type="hidden" />

@{
    const string hideRecoveryBlockAttributeName = "PassengerPage.HideRecoveryBlock";
    var customer = await workContext.GetCurrentCustomerAsync();
    var hideRecoveryBlock = await genericAttributeService.GetAttributeAsync<bool>(customer, hideRecoveryBlockAttributeName);

    const string hideLocationBlockAttributeName = "PassengerPage.HideLocationBlock";
    var hideLocationBlock = await genericAttributeService.GetAttributeAsync<bool>(customer, hideLocationBlockAttributeName);

    const string hidePersonalBlockAttributeName = "PassengerPage.HidePersonalBlock";
    var hidePersonalBlock = await genericAttributeService.GetAttributeAsync<bool>(customer, hidePersonalBlockAttributeName);

    const string hideCardTravelBlockAttributeName = "PassengerPage.HideCardTravelBlock";
    var hideCardTravelBlock = await genericAttributeService.GetAttributeAsync<bool>(customer, hideCardTravelBlockAttributeName);

    const string hidePictureBlockAttributeName = "PassengerPage.HidePictureBlock";
    var hidePictureBlock = await genericAttributeService.GetAttributeAsync<bool>(customer, hidePictureBlockAttributeName);
}

<style>

    .select2-container
    .select2-selection--single {
        border: 1px solid #ced4da;
        border-radius: 0;
        height: 38px;
    }
</style>

<section class="content">
    <div class="container-fluid">
        <div class="form-horizontal">
            <nop-cards id="passenger-cards">

                <nop-card asp-name="passenger-personal" asp-icon="fas fa-user" asp-title="@T("Admin.Passengers.Passengers.PersonalInformation")" asp-hide-block-attribute-name="@hidePersonalBlockAttributeName" asp-hide="@hidePersonalBlock" asp-advanced="false">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="PersonName" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-editor asp-for="PersonName" />
                                        <span asp-validation-for="PersonName"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="BirthYear" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-editor asp-for="BirthYear" />
                                        <span asp-validation-for="BirthYear"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="Education" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-select asp-for="Education" asp-items="Model.AvailableEducationLevels" />
                                        <span asp-validation-for="Education"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="IsMarried" />
                                    </div>
                                    <div class="col-md-9">
                                        <div class="raw">
                                            <div class="form-check">
                                                <input type="radio" class="form-check-input" name="IsMarried" id="IsMarried_False" value="false" @(!Model.IsMarried ? Html.Raw("checked") : null)>
                                                <label class="form-check-label" for="IsMarried_False">
                                                    @T("Admin.Passengers.Fields.IsSingle")
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input type="radio" class="form-check-input" name="IsMarried" id="IsMarried_True" value="true" @(Model.IsMarried? Html.Raw("checked") : null)>
                                                <label class="form-check-label" for="IsMarried_True">
                                                    @T("Admin.Passengers.Fields.IsMarried")
                                                </label>
                                            </div>
                                        </div>
                                        <span asp-validation-for="IsMarried"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="IsEmployed" />
                                    </div>
                                    <div class="col-md-9">
                                        <div class="raw">
                                            <div class="form-check">
                                                <input type="radio" class="form-check-input" name="IsEmployed" id="IsEmployed_False" value="false" @(!Model.IsEmployed ? Html.Raw("checked") : null)>
                                                <label class="form-check-label" for="IsEmployed_False">
                                                    @T("Admin.Passengers.Fields.IsUnemployed")
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input type="radio" class="form-check-input" name="IsEmployed" id="IsEmployed_True" value="true" @(Model.IsEmployed? Html.Raw("checked") : null)>
                                                <label class="form-check-label" for="IsEmployed_True">
                                                    @T("Admin.Passengers.Fields.IsEmployed")
                                                </label>
                                            </div>
                                        </div>
                                        <span asp-validation-for="IsEmployed"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="HasCompanion" />
                                    </div>
                                    <div class="col-md-9">
                                        <div class="raw">
                                            <div class="form-check">
                                                <input type="radio" class="form-check-input" name="HasCompanion" id="HasCompanion_Unknown" value="" @(Model.HasCompanion == null ? Html.Raw("checked") : null)>
                                                <label class="form-check-label" for="HasCompanion_Unknown">
                                                    @T("Admin.Passengers.Fields.HasCompanion.Unknown")
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input type="radio" class="form-check-input" name="HasCompanion" id="HasCompanion_False" value="false" @(Model.HasCompanion == false ? Html.Raw("checked") : null)>
                                                <label class="form-check-label" for="HasCompanion_False">
                                                    @T("Admin.Passengers.Fields.HasCompanion.No")
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input type="radio" class="form-check-input" name="HasCompanion" id="HasCompanion_True" value="true" @(Model.HasCompanion == true ? Html.Raw("checked") : null)>
                                                <label class="form-check-label" for="HasCompanion_True">
                                                    @T("Admin.Passengers.Fields.HasCompanion.Yes")
                                                </label>
                                            </div>
                                        </div>
                                        <span asp-validation-for="HasCompanion"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="RecoveryNo" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-editor asp-for="RecoveryNo" />
                                        <span asp-validation-for="RecoveryNo"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </nop-card>


                <nop-card asp-name="passenger-location" asp-icon="fas fa-map-marker-alt" asp-title="@T("Admin.Passengers.Passengers.LocationInformation")" asp-hide-block-attribute-name="@hideLocationBlockAttributeName" asp-hide="@hideLocationBlock" asp-advanced="false">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="CityId" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-select asp-for="CityId" asp-items="Model.AvailableCities" />
                                        <span asp-validation-for="CityId"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="AgencyId" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-select asp-for="AgencyId" asp-items="Model.AvailableAgencies" />
                                        <span asp-validation-for="AgencyId"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="ClinicId" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-select asp-for="ClinicId" asp-items="Model.AvailableClinics" />
                                        <span asp-validation-for="ClinicId"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="GuideNameAndLegionNo" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-editor asp-for="GuideNameAndLegionNo" />
                                        <span asp-validation-for="GuideNameAndLegionNo"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </nop-card>

                <nop-card asp-name="passenger-card-travel" asp-icon="fas fa-id-card" asp-title="@T("Admin.Passengers.Passengers.CardTravelInformation")" asp-hide-block-attribute-name="@hideCardTravelBlockAttributeName" asp-hide="@hideCardTravelBlock" asp-advanced="false">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="CardNo" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-editor asp-for="CardNo" />
                                        <span asp-validation-for="CardNo"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="AntiX1" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-select asp-for="AntiX1" asp-items="Model.AvailableAntiXItems" />
                                        <span asp-validation-for="AntiX1"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="AntiX2" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-select asp-for="AntiX2" asp-items="Model.AvailableAntiXItems" />
                                        <span asp-validation-for="AntiX2"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="TravelStartDateUtc" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-editor asp-for="TravelStartDateUtc" />
                                        <span asp-validation-for="TravelStartDateUtc"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="TravelEndDateUtc" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-editor asp-for="TravelEndDateUtc" />
                                        <span asp-validation-for="TravelEndDateUtc"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @if (Model.Id > 0)
                        {
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <div class="col-md-3">
                                            <nop-label asp-for="CreatedOnUtc" />
                                        </div>
                                        <div class="col-md-9">
                                            <div class="form-text-row">@Model.CreatedOnUtc</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </nop-card>

                <nop-card asp-name="passenger-picture" asp-icon="fas fa-image" asp-title="@T("Admin.Passengers.Passengers.Picture")" asp-hide-block-attribute-name="@hidePictureBlockAttributeName" asp-hide="@hidePictureBlock" asp-advanced="false">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group row">
                                    <div class="col-md-3">
                                        <nop-label asp-for="PictureId" />
                                    </div>
                                    <div class="col-md-9">
                                        <nop-editor asp-for="PictureId" />
                                        <span asp-validation-for="PictureId"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </nop-card>

                @await Component.InvokeAsync(typeof(AdminWidgetViewComponent), new { widgetZone = AdminWidgetZones.PassengerDetailsBlock, additionalData = Model })
            </nop-cards>
        </div>
    </div>
</section>

<script>
    $(document).ready(function () {
        var citySelect = $("#@Html.IdFor(model => model.CityId)");
        var agencySelect = $("#@Html.IdFor(model => model.AgencyId)");
        var agenciesUrl = "@Url.Action("GetAgenciesByCityId", "Passenger")";
        var clinicsUrl = "@Url.Action("GetClinicsByCityId", "Passenger")";
        var defaultAgencyText = "@T("Admin.Common.Select")";
        var defaultClinicText = "@T("Admin.Common.Select")";
        var clinicSelect = $("#@Html.IdFor(model => model.ClinicId)");
        var showAllMode = citySelect.val() === "-1";

        var antiX1Select = $("#@Html.IdFor(model => model.AntiX1)");
        var antiX2Select = $("#@Html.IdFor(model => model.AntiX2)");
        var suppressCityChange = false;

        var recoveryNoInput = $("#@Html.IdFor(model => model.RecoveryNo)");
        if (recoveryNoInput.val() === "0") {
            recoveryNoInput.val("");
        }

        //initialize select2 for searchable dropdowns
        citySelect.select2({ dir: 'rtl', width: '100%' });
        agencySelect.select2({ dir: 'rtl', width: '100%' });
        clinicSelect.select2({ dir: 'rtl', width: '100%' });
        antiX1Select.select2({ dir: 'rtl', width: '100%' });
        antiX2Select.select2({ dir: 'rtl', width: '100%' });

        function loadAgencies(cityId, selectedAgencyId) {
            agencySelect.empty();
            agencySelect.append($("<option></option>").attr("value", "0").text(defaultAgencyText));

            if (!cityId || cityId === "0") {
                agencySelect.trigger('change.select2');
                return;
            }

            $.getJSON(agenciesUrl, { cityId: cityId }, function (data) {
                $.each(data, function (index, item) {
                    var option = $("<option></option>").attr("value", item.id).text(item.name);
                    if (item.cityId) {
                        option.attr("data-city-id", item.cityId);
                    }
                    if (selectedAgencyId && selectedAgencyId.toString() === item.id.toString()) {
                        option.attr("selected", "selected");
                    }
                    agencySelect.append(option);
                });
                agencySelect.trigger('change.select2');
            });
        }

        function loadClinics(cityId, selectedClinicId) {
            clinicSelect.empty();
            clinicSelect.append($("<option></option>").attr("value", "0").text(defaultClinicText));

            if (!cityId || cityId === "0") {
                clinicSelect.trigger('change.select2');
                return;
            }

            $.getJSON(clinicsUrl, { cityId: cityId }, function (data) {
                $.each(data, function (index, item) {
                    var option = $("<option></option>").attr("value", item.id).text(item.name);
                    if (item.cityId) {
                        option.attr("data-city-id", item.cityId);
                    }
                    if (selectedClinicId && selectedClinicId.toString() === item.id.toString()) {
                        option.attr("selected", "selected");
                    }
                    clinicSelect.append(option);
                });
                clinicSelect.trigger('change.select2');
            });
        }

        citySelect.on("change", function () {
            if (suppressCityChange) return;
            showAllMode = $(this).val() === "-1";
            loadAgencies($(this).val(), 0);
            if (!showAllMode) {
                loadClinics($(this).val(), 0);
            }
        });

        agencySelect.on("change", function () {
            if (!showAllMode) return;
            var selectedOption = $(this).find("option:selected");
            var selectedCityId = selectedOption.attr("data-city-id");
            if (!selectedCityId) return;
            suppressCityChange = true;
            citySelect.val(selectedCityId).trigger('change.select2');
            suppressCityChange = false;
            loadClinics(selectedCityId, 0);
        });

        if (citySelect.val() && citySelect.val() !== "0") {
            loadAgencies(citySelect.val(), agencySelect.val());
            loadClinics(citySelect.val(), clinicSelect.val());
        }
    });
</script>
